---
title: "Drama Analysis"
author: "Ira Pavlova"
date: "May 2017"
output:
  github_document:
    html_preview: false
---

### This project is devoted to studying the evolution of Russian drama. The study is based on the Russian Drama Corpus which now contains 49 Russian plays encoded in TEI. The creation time of plays ranges from 1747 to 1925.
```{r results='hide', warning=FALSE, message=FALSE}
library(tidyverse)
library(plotly)
library(plotrix)
library(network)
library(sna)
library(GGally)
library(geomnet)
library(ggnetwork)
library(igraph)
library(tools)
library(gridExtra)

data = read.csv('calculations.csv', stringsAsFactors=FALSE)
data = data.frame(data)
data[data=="empty weights"] <- 0
data[, 5:6] <- sapply(data[, 5:6], as.numeric)
data
```

### This graph shows how the number of characters in plays was changing from 1750 to 1950. The observations are the mean number of characters in plays of a particular year.
```{r}
char_data <- aggregate(data[, 4], list(Year_of_creation=data$Year_of_creation), mean)
BG <- subset(char_data, Year_of_creation == "1825")

char_data %>% ggplot(aes(Year_of_creation, x)) +
  geom_point() +
  geom_line() + scale_x_continuous(breaks=seq(1700, 1950, 50)) +
  geom_text(data=BG, label="Boris Godunov", vjust=1) +
  labs(title='Number of characters in Russian drama',
       y='Number of characters', x='Year of creation')
```

### This graph shows how the number of characters in plays was changing from 1750 to 1950 for the plays with 4/10/20/30 or more segments.
```{r}

char_data_4 <- subset(data, Num_of_scenes >= 4)

char_data_4 <- ggplot(char_data_4, aes(Year_of_creation, Num_of_char, label=Play)) +
  geom_point(size=0.2) + scale_x_continuous(breaks=seq(1700, 1950, 50)) +
  geom_text(aes(label=Play),hjust=0, vjust=0, size=1.5) +
  labs(title='in plays of 4 and more segments',
       y='Number of characters', x='Year of creation')

char_data_10 <- subset(data, Num_of_scenes >= 10)

char_data_10 <- ggplot(char_data_10, aes(Year_of_creation, Num_of_char, label=Play)) +
  geom_point(size=0.2) + scale_x_continuous(breaks=seq(1700, 1950, 50)) +
  geom_text(aes(label=Play),hjust=0, vjust=0, size=1.5) +
  labs(title='in plays of 10 and more segments',
       y='Number of characters', x='Year of creation')

char_data_20 <- subset(data, Num_of_scenes >= 20)

char_data_20 <- ggplot(char_data_20, aes(Year_of_creation, Num_of_char, label=Play)) +
  geom_point(size=0.2) + scale_x_continuous(breaks=seq(1700, 1950, 50)) +
  geom_text(aes(label=Play),hjust=0, vjust=0, size=1.5) +
  labs(title='in plays of 20 and more segments',
       y='Number of characters', x='Year of creation')

char_data_30 <- subset(data, Num_of_scenes >= 30)

char_data_30 <- ggplot(char_data_30, aes(Year_of_creation, Num_of_char, label=Play)) +
  geom_point(size=0.2) + scale_x_continuous(breaks=seq(1700, 1950, 50)) +
  geom_text(aes(label=Play),hjust=0, vjust=0, size=1.5) +
  labs(title='in plays of 30 and more segments',
       y='Number of characters', x='Year of creation')

grid.arrange(char_data_4,
              char_data_10,
              char_data_20,
              char_data_30,
              nrow=2, ncol=2,
             top="Number of charaters in Russian drama")


```


### This graph shows how the number of scenes/acts in plays was changing from 1750 to 1950. The observations are the mean number of scenes/acts in plays of a particular year.
```{r}
scenes_data <- aggregate(data[, 3], list(Year_of_creation=data$Year_of_creation), mean)

scenes_data %>% ggplot(aes(Year_of_creation, x)) +
  geom_point() +
  geom_line() + scale_x_continuous(breaks=seq(1700, 1950, 50)) +
  labs(title='Number of scenes/acts in Russian drama',
       y='Number of scenes/acts', x='Year of creation')
```

### This graph shows how the maximum degree of a character in plays was changing from 1750 to 1950. The observations are the mean number of max degree in plays of a particular year.
```{r}
degree_data <- aggregate(data[, 6], list(Year_of_creation=data$Year_of_creation), mean)
BG <- subset(degree_data, Year_of_creation == "1825")

degree_data %>% ggplot(aes(Year_of_creation, x)) +
  geom_point() +
  geom_line() + scale_x_continuous(breaks=seq(1700, 1950, 50)) +
  geom_text(data=BG, label="Boris Godunov") +
  labs(title='Max character degree in Russian drama',
       y='Max degree', x='Year of creation')
```

### Setting directories for CSV files to generate network graphs
```{r}
csv_list_ilibrary <- list.files('../TEI/current_CSV_files_extracted_from_TEI/ilibrary', full.names=T, pattern = "\\.csv$")

csv_list_wikisource <- list.files('../TEI/current_CSV_files_extracted_from_TEI/wikisource', full.names=T, pattern = "\\.csv$")
```

### Making network visualization (ggplot)
```{r}
make_ggplot_graphs <- function(input){
  
            output <- file_path_sans_ext(basename(file.path(input)))
            print(output)
            play <- read.csv(input, sep = ";")
            num_of_rows <- nrow(play)
            if(num_of_rows != 0)
            {
            play <- play[, c(1, 3, 4)]
            play
            
            ggplot(data = play, aes(from_id=Source, to_id=Target)) +
              geom_net(layout.alg ="kamadakawai", 
              size = 2, labelon = TRUE, vjust = -0.6, ecolour = "grey60",
              directed =FALSE, fontsize = 3, ealpha = 0.5)
            
            ggsave(paste(output,".png"),
                   path= '/Users/IrinaPavlova/Desktop/Uni/Бакалавриат/2015-2016/Programming/github desktop/RusDraCor/Calculating_stuff_in_plays/network_graphs/ggplot')
            
  } else {print('empty graph')}}

for(file in csv_list_ilibrary) make_ggplot_graphs(file)
for(file in csv_list_wikisource) make_ggplot_graphs(file)

```

### Making network visualization (igraph)
```{r}
make_igraph_graphs <- function(input)
  {
            output <- file_path_sans_ext(basename(file.path(input)))
            print(output)
            play <- read.csv(input, sep = ";")
            num_of_rows <- nrow(play)
            if(num_of_rows != 0)
            {
              play <- play[, c(1, 3, 4)]
            play
net <- graph_from_data_frame(d=play, directed=F)
E(net)$weight <- play$Weight
# net <- network(play, directed=FALSE)

clust <- cluster_optimal(net)
modularity(clust)
membership(clust)

net

E(net)$weight > 1

# prettyColors <- c("turquoise4", "azure4", "olivedrab","deeppink4")
# communityColors <- prettyColors[membership(clust)]

layout = layout.fruchterman.reingold(net)

layout=layout.kamada.kawai(net, kkconst=50)

# vertex.label= ifelse(V(net)$name %in% c('Drugoj'),V(net)$name, NA)

filename= paste('/Users/IrinaPavlova/Desktop/Uni/Бакалавриат/2015-2016/Programming/github desktop/RusDraCor/Calculating_stuff_in_plays/network_graphs/igraph/', output, '.png', sep='')

png(filename, width=3.25,height=3.25, units='in', res=600)

plot(net,
     vertex.size=3,
     edge.arrow.size=.6,
     vertex.label=V(net)$name,
     edge.width=E(net)$weight*0.5,
     layout=layout.graphopt,
     vertex.label.color = "black",
     vertex.label.cex = 0.5,
     vertex.color = membership(clust),
     vertex.label.dist=0.5,
     )
     
dev.off() }
            else {print('empty graph')
}}

for(file in csv_list_ilibrary) make_igraph_graphs(file)
for(file in csv_list_wikisource) make_igraph_graphs(file)

```

### Notes
# 1. Keep CamelCase when tranforming TEI to CSV
# 2. Use clustering in igraph
# 3. Add degree tables (as vertices to net)